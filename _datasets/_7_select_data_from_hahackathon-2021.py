"""Generated by GPT-5.1, reviewed by Shiling Deng, 26/11/2025"""
import os
import pandas as pd
import matplotlib.pyplot as plt

DATA_PATH = "download_cache/hahackathon-2021/datasets/hahackathon_train.csv"
OUT_DIR = "hahackathon_subsets"


def main():
    os.makedirs(OUT_DIR, exist_ok=True)

    # 0. Load dataset
    df = pd.read_csv(DATA_PATH)

    # ======================================================
    # 1–3. NON-HUMOROUS SAMPLES (is_humor = 0)
    # ======================================================
    non_humor_df = df[df["is_humor"] == 0].copy()

    # Sort by offense_rating
    non_humor_sorted = non_humor_df.sort_values("offense_rating")

    # Bottom 250 (lowest offense_rating) and top 250 (highest offense_rating)
    bottom_250 = non_humor_sorted.head(250)
    top_250 = non_humor_sorted.tail(250)

    # Merge into non_humorous
    non_humorous = pd.concat([bottom_250, top_250], ignore_index=True)
    print(f"Non-humorous subset size: {len(non_humorous)}")

    # ======================================================
    # 4–7. HUMOROUS SAMPLES (is_humor = 1) with new selection method
    # ======================================================
    humor_df = df[df["is_humor"] == 1].copy()

    # 5. score = humor_rating * offense_rating, select top 250
    humor_df["score_prod"] = humor_df["humor_rating"] * humor_df["offense_rating"]
    high_prod = humor_df.sort_values("score_prod", ascending=False).head(250)

    # 6. score = humor_rating / (offense_rating + eps), select top 250
    eps = 1e-5  # small value to avoid division by zero
    humor_df["score_ratio"] = humor_df["humor_rating"] / (humor_df["offense_rating"] + eps)
    high_ratio = humor_df.sort_values("score_ratio", ascending=False).head(250)

    # 7. Merge the selected 500 (remove duplicates just in case)
    humorous = pd.concat([high_prod, high_ratio], ignore_index=True)
    if "id" in humorous.columns:
        humorous = humorous.drop_duplicates(subset="id", keep="first").reset_index(drop=True)

    print(f"Humorous subset size (after merging & dedup): {len(humorous)}")

    # ======================================================
    # 8. MERGE non_humorous and humorous
    # ======================================================
    combined = pd.concat([non_humorous, humorous], ignore_index=True)
    print(f"Combined subset size: {len(combined)}")
    # create binary is_offensive column 
    combined["is_offensive"] = (combined["offense_rating"] > 0).astype(int)

    # Save the final combined subset into a CSV file
    output_csv = os.path.join(OUT_DIR, "combined_subset.csv")
    combined.to_csv(output_csv, index=False, encoding="utf-8")
    print(f"Saved combined subset to: {output_csv}")


    # ======================================================
    # 9–10. Draw and save figures for is_humor, humor_rating, offense_rating
    # ======================================================

    # is_humor distribution
    plt.figure()
    combined["is_humor"].value_counts().sort_index().plot(kind="bar")
    plt.title("is_humor distribution (subset)")
    plt.xlabel("is_humor")
    plt.ylabel("Count")
    plt.xticks(rotation=0)
    plt.tight_layout()
    out_path = os.path.join(OUT_DIR, "subset_is_humor_distribution.png")
    plt.savefig(out_path, dpi=300)
    plt.close()
    print(f"Saved: {out_path}")

    # humor_rating distribution
    plt.figure()
    combined["humor_rating"].hist(bins=20)
    plt.title("humor_rating distribution (subset)")
    plt.xlabel("humor_rating")
    plt.ylabel("Count")
    plt.tight_layout()
    out_path = os.path.join(OUT_DIR, "subset_humor_rating_distribution.png")
    plt.savefig(out_path, dpi=300)
    plt.close()
    print(f"Saved: {out_path}")

    # offense_rating distribution
    plt.figure()
    combined["offense_rating"].hist(bins=20)
    plt.title("offense_rating distribution (subset)")
    plt.xlabel("offense_rating")
    plt.ylabel("Count")
    plt.tight_layout()
    out_path = os.path.join(OUT_DIR, "subset_offense_rating_distribution.png")
    plt.savefig(out_path, dpi=300)
    plt.close()
    print(f"Saved: {out_path}")


if __name__ == "__main__":
    main()

# Non-humorous subset size: 500
# Humorous subset size (after merging & dedup): 500
# Combined subset size: 1000
# Saved combined subset to: hahackathon_subsets/combined_subset.csv
# Saved: hahackathon_subsets/subset_is_humor_distribution.png
# Saved: hahackathon_subsets/subset_humor_rating_distribution.png
# Saved: hahackathon_subsets/subset_offense_rating_distribution.png
